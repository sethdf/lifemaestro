#!/usr/bin/env bash
# session - AI session management
# 12-Factor CLI compliant

set -euo pipefail

MAESTRO_ROOT="${MAESTRO_ROOT:-${XDG_CONFIG_HOME:-$HOME/.config}/lifemaestro}"

source "$MAESTRO_ROOT/core/init.sh"
maestro::init 2>/dev/null || true

# Parse common flags
cli::parse_common_flags "$@"
set -- "${MAESTRO_ARGS[@]}"

cmd="${1:-status}"
shift || true

case "$cmd" in
    # ============================================
    # CREATE SESSIONS
    # ============================================
    new|create)
        type="${1:-exploration}"
        name="${2:-}"
        if [[ -z "$name" ]]; then
            if cli::has_stdin; then
                name=$(cat)
            elif cli::is_tty; then
                read -p "Session name: " name
            else
                cli::die_usage "Usage: session new <type> <name>"
            fi
        fi
        session::create "$type" "$name"
        ;;
    ticket|t)
        if [[ $# -lt 1 ]]; then
            cli::die_usage "Usage: session ticket <ticket-ref> [description]"
        fi
        session::ticket "$@"
        ;;
    work|w)
        if [[ $# -lt 1 ]]; then
            cli::die_usage "Usage: session work <name>"
        fi
        session::work "$@"
        ;;
    home|h)
        if [[ $# -lt 1 ]]; then
            cli::die_usage "Usage: session home <name>"
        fi
        session::home "$@"
        ;;
    infra|i)
        if [[ $# -lt 1 ]]; then
            cli::die_usage "Usage: session infra <name>"
        fi
        session::infra "$@"
        ;;
    learn|l)
        if [[ $# -lt 1 ]]; then
            cli::die_usage "Usage: session learn <topic>"
        fi
        session::learn "$@"
        ;;

    # ============================================
    # NAVIGATION
    # ============================================
    list|ls)
        session::list "$@"
        ;;
    go|g)
        session::go "$@"
        ;;

    # ============================================
    # CONTEXT
    # ============================================
    switch|sw)
        if [[ $# -lt 1 ]]; then
            cli::die_usage "Usage: session switch <work|home>"
        fi
        session::switch "$@"
        ;;
    context|ctx)
        session::show_context
        ;;

    # ============================================
    # UTILITIES
    # ============================================
    close)
        # Session close requires Claude Code for AI analysis
        if [[ -z "${CLAUDE_CODE:-}" ]] && [[ -z "${ANTHROPIC_API_KEY:-}" ]]; then
            cli::error "Session close requires Claude Code for AI-powered categorization."
            cli::out ""
            cli::out "Run 'session close' inside Claude Code, or use:"
            cli::out "  session done    # Quick close without AI analysis"
            exit 1
        fi
        # Check for CLAUDE.md
        if [[ ! -f "CLAUDE.md" ]]; then
            cli::error "No CLAUDE.md found. Is this a session directory?"
            exit 1
        fi
        # Print instructions for Claude to handle
        cli::out "Invoke /session-close skill to close this session with AI categorization."
        cli::out "Reading session from: $PWD"
        ;;
    compact)
        session::compact
        ;;
    done|complete)
        session::done
        ;;
    status|s)
        session::show_context
        cli::out ""
        cli::out "Current directory: $PWD"
        if [[ -f "CLAUDE.md" ]]; then
            cli::out "Session file: CLAUDE.md"
        fi
        if [[ -f ".session.json" ]]; then
            cli::out "Metadata: .session.json"
            if command -v jq &>/dev/null; then
                session_status=$(jq -r '.status // "unknown"' .session.json)
                category=$(jq -r '.category // "uncategorized"' .session.json)
                cli::out "  Status: $session_status, Category: $category"

                # Show skills used
                skills_count=$(jq -r '.skills_used | length' .session.json 2>/dev/null || echo "0")
                if [[ "$skills_count" -gt 0 ]]; then
                    cli::out "  Skills used: $skills_count"
                    jq -r '.skills_used[] | "    - \(.name) (\(.invocations)x)"' .session.json 2>/dev/null
                fi

                # Show models used
                models_count=$(jq -r '.models_used | length' .session.json 2>/dev/null || echo "0")
                if [[ "$models_count" -gt 0 ]]; then
                    primary=$(jq -r '.primary_model // "none"' .session.json)
                    cli::out "  Models used: $models_count (primary: $primary)"
                    jq -r '.models_used[] | "    - \(.model) (\(.invocations)x)"' .session.json 2>/dev/null
                fi

                # Show clients used
                clients_count=$(jq -r '.clients_used | length' .session.json 2>/dev/null || echo "0")
                if [[ "$clients_count" -gt 0 ]]; then
                    primary_client=$(jq -r '.primary_client // "none"' .session.json)
                    cli::out "  Clients used: $clients_count (primary: $primary_client)"
                    jq -r '.clients_used[] | "    - \(.client) (\(.invocations)x)"' .session.json 2>/dev/null
                fi
            fi
        fi
        ;;
    track-client)
        # Track client usage in current session
        client_name="${1:-}"
        if [[ -z "$client_name" ]]; then
            cli::die_usage "Usage: session track-client <client-name>"
        fi
        if [[ ! -f ".session.json" ]]; then
            cli::warn "No .session.json in current directory"
            exit 0
        fi
        source "$MAESTRO_ROOT/sessions/schema.sh"
        session::track_client "." "$client_name"
        cli::out "Tracked client: $client_name"
        ;;
    track-model)
        # Track model usage in current session
        model_name="${1:-}"
        if [[ -z "$model_name" ]]; then
            cli::die_usage "Usage: session track-model <model-name>"
        fi
        if [[ ! -f ".session.json" ]]; then
            cli::warn "No .session.json in current directory"
            exit 0
        fi
        source "$MAESTRO_ROOT/sessions/schema.sh"
        session::track_model "." "$model_name"
        cli::out "Tracked model: $model_name"
        ;;
    track-skill)
        # Track skill usage in current session
        skill_name="${1:-}"
        if [[ -z "$skill_name" ]]; then
            cli::die_usage "Usage: session track-skill <skill-name>"
        fi
        if [[ ! -f ".session.json" ]]; then
            cli::warn "No .session.json in current directory"
            exit 0
        fi
        source "$MAESTRO_ROOT/sessions/schema.sh"
        session::track_skill "." "$skill_name"
        cli::out "Tracked: $skill_name"
        ;;
    migrate)
        "$MAESTRO_ROOT/.claude/skills/session-manager/scripts/session-migrate.sh" "$@"
        ;;

    # ============================================
    # HELP
    # ============================================
    version|-v|--version)
        cli::out "session (lifemaestro) $MAESTRO_VERSION"
        exit $EXIT_SUCCESS
        ;;
    help|--help|-h)
        cli::out "session - AI Session Management"
        cli::out ""
        cli::out "Usage: session [options] <command> [args...]"
        cli::out ""
        cli::out "Options:"
        cli::out "    -q, --quiet     Suppress non-essential output"
        cli::out "    -v, --version   Show version"
        cli::out "    -h, --help      Show this help"
        cli::out ""
        cli::out "Create sessions:"
        cli::out "    new <type> <name>    Create new session"
        cli::out "    ticket <ref> [desc]  Create ticket session (auto-fetches details)"
        cli::out "    work <name>          Create work exploration"
        cli::out "    home <name>          Create home exploration"
        cli::out "    infra <name>         Create infrastructure session"
        cli::out "    learn <topic>        Create learning session"
        cli::out ""
        cli::out "Navigation:"
        cli::out "    list [context]       List sessions"
        cli::out "    go [context]         Jump to session (fzf)"
        cli::out ""
        cli::out "Context:"
        cli::out "    switch <ctx>         Switch to work/home context"
        cli::out "    context              Show current context"
        cli::out ""
        cli::out "Utilities:"
        cli::out "    close                Close session with AI categorization (Claude Code)"
        cli::out "    compact              Archive CLAUDE.md"
        cli::out "    done                 Quick close without AI analysis"
        cli::out "    status               Show current status"
        cli::out "    track-client <name>  Track AI client usage in session"
        cli::out "    track-model <name>   Track model usage in session"
        cli::out "    track-skill <name>   Track skill usage in session"
        cli::out "    migrate [--dry-run]  Add .session.json to existing sessions"
        cli::out ""
        cli::out "Aliases (claude-sessions compatible):"
        cli::out "    cc, ccticket, ccw, cch, ccinfra, cclearn, ccls, ccgo"
        exit $EXIT_SUCCESS
        ;;
    *)
        cli::die_usage "Unknown command: $cmd"
        ;;
esac
