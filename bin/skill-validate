#!/usr/bin/env bash
# Validate SKILL.md files against agentskills.io spec
# Usage: skill-validate [skill-name|--all]

set -uo pipefail

SKILLS_DIR="${MAESTRO_ROOT:-$(cd "$(dirname "$0")/.." && pwd)}/.claude/skills"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

ok()   { echo -e "${GREEN}✓${NC} $*"; }
warn() { echo -e "${YELLOW}⚠${NC} $*"; }
err()  { echo -e "${RED}✗${NC} $*"; }

validate_skill() {
    local skill_dir="$1"
    local skill_name=$(basename "$skill_dir")
    local skill_file="$skill_dir/SKILL.md"
    local errors=0
    local warnings=0

    echo -e "\n${GREEN}Validating:${NC} $skill_name"

    # Check SKILL.md exists
    if [[ ! -f "$skill_file" ]]; then
        err "Missing SKILL.md"
        return 1
    fi

    # Check YAML frontmatter exists
    if ! head -1 "$skill_file" | grep -q '^---$'; then
        err "Missing YAML frontmatter (must start with ---)"
        ((errors++))
    fi

    # Check required fields
    local name=$(awk '/^name:/{print $2; exit}' "$skill_file")
    local desc=$(awk '/^description:/{found=1; next} found && /^[a-z]/{exit} found' "$skill_file" | head -1)

    if [[ -z "$name" ]]; then
        err "Missing 'name' field in frontmatter"
        ((errors++))
    elif [[ "$name" != "$skill_name" ]]; then
        warn "name '$name' doesn't match directory '$skill_name'"
        ((warnings++))
    fi

    if [[ -z "$desc" ]] && ! grep -q '^description:' "$skill_file"; then
        err "Missing 'description' field in frontmatter"
        ((errors++))
    fi

    # Check name format (lowercase, hyphens, max 64)
    if [[ -n "$name" ]]; then
        if [[ ${#name} -gt 64 ]]; then
            err "name exceeds 64 characters"
            ((errors++))
        fi
        if [[ "$name" =~ [A-Z] ]]; then
            warn "name should be lowercase"
            ((warnings++))
        fi
    fi

    # Check line count (should be < 500)
    local lines=$(wc -l < "$skill_file")
    if [[ $lines -gt 500 ]]; then
        warn "SKILL.md has $lines lines (recommend < 500)"
        ((warnings++))
    fi

    # Check for references/ if mentioned
    if grep -q 'references/' "$skill_file" && [[ ! -d "$skill_dir/references" ]]; then
        err "References mentioned but references/ directory missing"
        ((errors++))
    fi

    # Check for scripts/ if mentioned (exclude transcripts/ false positives)
    if grep -qE '(^|[^a-z])scripts/' "$skill_file" && [[ ! -d "$skill_dir/scripts" ]]; then
        err "Scripts mentioned but scripts/ directory missing"
        ((errors++))
    fi

    # Check scripts are executable
    if [[ -d "$skill_dir/scripts" ]]; then
        shopt -s nullglob
        for script in "$skill_dir/scripts"/*.sh; do
            if [[ ! -x "$script" ]]; then
                warn "$(basename "$script") is not executable"
                ((warnings++))
            fi
        done
        shopt -u nullglob
    fi

    # Summary
    if [[ $errors -eq 0 && $warnings -eq 0 ]]; then
        ok "Valid"
        return 0
    elif [[ $errors -eq 0 ]]; then
        warn "$warnings warning(s)"
        return 0
    else
        err "$errors error(s), $warnings warning(s)"
        return 1
    fi
}

# Main
if [[ "${1:-}" == "--all" || -z "${1:-}" ]]; then
    total=0
    passed=0
    for skill_dir in "$SKILLS_DIR"/*/; do
        [[ -d "$skill_dir" ]] || continue
        skill_path="${skill_dir%/}"
        # Skip symlinks (vendor skills)
        [[ -L "$skill_path" ]] && continue
        ((total++))
        validate_skill "$skill_path" && ((passed++)) || true
    done
    echo -e "\n${GREEN}Results:${NC} $passed/$total skills valid"
else
    skill_dir="$SKILLS_DIR/$1"
    if [[ ! -d "$skill_dir" ]]; then
        err "Skill not found: $1"
        exit 1
    fi
    validate_skill "$skill_dir"
fi
