#!/usr/bin/env bash
# ai-access - Manage AI provider authentication and access methods
# Uses baton service for centralized credential management when available

set -euo pipefail

MAESTRO_ROOT="${MAESTRO_ROOT:-${XDG_CONFIG_HOME:-$HOME/.config}/lifemaestro}"
MAESTRO_STATE="${MAESTRO_STATE:-${XDG_STATE_HOME:-$HOME/.local/state}/lifemaestro}"
AI_ACCESS_FILE="$MAESTRO_STATE/ai-access.json"
BATON_URL="${BATON_URL:-http://localhost:4000}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

log_info()  { echo -e "${BLUE}▶${NC} $*"; }
log_ok()    { echo -e "${GREEN}✓${NC} $*"; }
log_warn()  { echo -e "${YELLOW}!${NC} $*"; }
log_error() { echo -e "${RED}✗${NC} $*" >&2; }

# ============================================
# BATON INTEGRATION
# ============================================

# Check if baton is running
baton_available() {
    curl -s --connect-timeout 1 "$BATON_URL/healthz" &>/dev/null
}

# Get auth status from baton
baton_auth_status() {
    local provider="$1"
    curl -s "$BATON_URL/auth/status/$provider" 2>/dev/null
}

# Setup auth via baton (returns export commands)
baton_auth_setup() {
    local provider="$1"
    local method="$2"
    curl -s "$BATON_URL/auth/setup" \
        -H "Content-Type: application/json" \
        -d "{\"provider\":\"$provider\",\"auth_method\":\"$method\"}" 2>/dev/null
}

# Check credential readiness via baton
baton_creds_ready() {
    local provider="$1"
    local response
    response=$(curl -s -w "\n%{http_code}" "$BATON_URL/healthz/creds?provider=$provider" 2>/dev/null)
    local http_code
    http_code=$(echo "$response" | tail -n1)
    [[ "$http_code" == "200" ]]
}

# Get keepalive status from baton
baton_keepalive_status() {
    curl -s "$BATON_URL/keepalive/status" 2>/dev/null
}

# ============================================
# ACCESS METHOD DEFINITIONS
# ============================================

declare -A ANTHROPIC_ACCESS=(
    [oauth]="Claude Code OAuth (Pro/Team subscription)"
    [api]="API Key (console.anthropic.com)"
    [bedrock]="AWS Bedrock"
)

declare -A GOOGLE_ACCESS=(
    [oauth]="Google OAuth (Free/Advanced subscription)"
    [api]="API Key (aistudio.google.com)"
    [vertex]="GCP Vertex AI"
)

declare -A OPENAI_ACCESS=(
    [oauth]="Codex OAuth (Plus/Pro/Team subscription)"
    [api]="API Key (platform.openai.com)"
    [azure]="Azure OpenAI"
)

usage() {
    cat <<EOF
ai-access - Manage AI provider access methods

Usage: ai-access <command> [args...]

Commands:
    status                      Show current access configuration
    <provider> <method>         Set default access method
    env <provider> [method]     Output env vars for access method (for eval)
    check <provider> [method]   Validate specific access method works

Providers & Methods:
    anthropic   oauth | api | bedrock
    google      oauth | api | vertex
    openai      oauth | api | azure

Examples:
    ai-access status                    # Show all access methods
    ai-access anthropic bedrock         # Switch Claude to Bedrock
    ai-access google vertex             # Switch Gemini to Vertex AI
    eval "\$(ai-access env anthropic)"   # Set env for current method

Integration:
    Uses baton service ($BATON_URL) when available for centralized
    credential management. Falls back to local logic if baton unavailable.
EOF
}

# ============================================
# STATE MANAGEMENT
# ============================================

ensure_state_file() {
    mkdir -p "$(dirname "$AI_ACCESS_FILE")"
    if [[ ! -f "$AI_ACCESS_FILE" ]]; then
        cat > "$AI_ACCESS_FILE" <<EOF
{
  "anthropic": { "default": "oauth" },
  "google": { "default": "oauth" },
  "openai": { "default": "api" }
}
EOF
    fi
}

get_default_access() {
    local provider="$1"
    ensure_state_file
    jq -r ".[\"$provider\"].default // \"oauth\"" "$AI_ACCESS_FILE"
}

set_default_access() {
    local provider="$1"
    local method="$2"
    ensure_state_file

    local tmp_file
    tmp_file=$(mktemp)
    jq --arg p "$provider" --arg m "$method" \
        '.[$p].default = $m' "$AI_ACCESS_FILE" > "$tmp_file"
    mv "$tmp_file" "$AI_ACCESS_FILE"
}

# ============================================
# ENVIRONMENT SETUP
# ============================================

# Output commands to disable OAuth token (for eval)
output_disable_oauth() {
    local provider="$1"

    case "$provider" in
        anthropic)
            for f in ~/.claude/auth.json ~/.config/claude/auth.json ~/.claude.json; do
                cat <<EOF
if [[ -f "$f" ]] && [[ ! -f "$f.disabled" ]]; then
    mv "$f" "$f.disabled"
    echo "# Disabled OAuth: $f"
fi
EOF
            done
            ;;
        openai)
            for f in ~/.codex/auth.json ~/.config/codex/auth.json; do
                cat <<EOF
if [[ -f "$f" ]] && [[ ! -f "$f.disabled" ]]; then
    mv "$f" "$f.disabled"
    echo "# Disabled OAuth: $f"
fi
EOF
            done
            ;;
    esac
}

# Output commands to re-enable OAuth token (for eval)
output_enable_oauth() {
    local provider="$1"

    case "$provider" in
        anthropic)
            for f in ~/.claude/auth.json ~/.config/claude/auth.json ~/.claude.json; do
                cat <<EOF
if [[ -f "$f.disabled" ]]; then
    mv "$f.disabled" "$f"
    echo "# Enabled OAuth: $f"
fi
EOF
            done
            ;;
        openai)
            for f in ~/.codex/auth.json ~/.config/codex/auth.json; do
                cat <<EOF
if [[ -f "$f.disabled" ]]; then
    mv "$f.disabled" "$f"
    echo "# Enabled OAuth: $f"
fi
EOF
            done
            ;;
    esac
}

# Output env setup for a specific access method (for eval)
output_env_setup() {
    local provider="$1"
    local method="${2:-$(get_default_access "$provider")}"

    echo "# ai-access env setup: $provider via $method"

    # Try baton first if available
    if baton_available; then
        local response
        response=$(baton_auth_setup "$provider" "$method")

        local success
        success=$(echo "$response" | jq -r '.success // false')

        if [[ "$success" == "true" ]]; then
            echo "# Using baton for credential management"
            echo "$response" | jq -r '.export_cmd // empty'

            # Handle OAuth file management locally (baton can't do this)
            if [[ "$method" == "oauth" ]]; then
                output_enable_oauth "$provider"
            else
                output_disable_oauth "$provider"
            fi

            echo "export AI_ACCESS_${provider^^}='$method'"
            return 0
        else
            local errors
            errors=$(echo "$response" | jq -r '.errors[]? // empty')
            echo "# Baton returned errors: $errors"
            echo "# Falling back to local credential lookup"
        fi
    fi

    # Fallback: local credential management
    output_env_setup_local "$provider" "$method"
}

# Local fallback for env setup (when baton unavailable)
output_env_setup_local() {
    local provider="$1"
    local method="$2"

    # First, clear conflicting auth
    case "$provider" in
        anthropic)
            echo "unset ANTHROPIC_API_KEY 2>/dev/null || true"
            echo "unset AWS_PROFILE AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN 2>/dev/null || true"
            ;;
        google)
            echo "unset GEMINI_API_KEY GOOGLE_API_KEY 2>/dev/null || true"
            ;;
        openai)
            echo "unset OPENAI_API_KEY AZURE_OPENAI_API_KEY AZURE_OPENAI_ENDPOINT 2>/dev/null || true"
            ;;
    esac

    # Then set up the desired method
    case "$provider:$method" in
        anthropic:oauth)
            output_enable_oauth anthropic
            echo "# Using Claude Code OAuth"
            ;;
        anthropic:api)
            output_disable_oauth anthropic
            local key
            if key=$(get_credential_local anthropic api 2>/dev/null); then
                echo "export ANTHROPIC_API_KEY='$key'"
            else
                echo "# WARNING: No API key found. Add to Bitwarden as 'Anthropic API'"
            fi
            ;;
        anthropic:bedrock)
            output_disable_oauth anthropic
            local profile="${AWS_PROFILE_ANTHROPIC:-default}"
            local region="${AWS_REGION_ANTHROPIC:-us-east-1}"
            echo "export AWS_PROFILE='$profile'"
            echo "export AWS_REGION='$region'"
            echo "# Using AWS Bedrock with profile: $profile"
            ;;
        google:oauth)
            echo "# Using Google OAuth (gemini login)"
            ;;
        google:api)
            local key
            if key=$(get_credential_local google api 2>/dev/null); then
                echo "export GEMINI_API_KEY='$key'"
            else
                echo "# WARNING: No API key found. Add to Bitwarden as 'Google AI API'"
            fi
            ;;
        google:vertex)
            local project="${GCP_PROJECT:-}"
            local region="${GCP_REGION:-us-central1}"
            [[ -n "$project" ]] && echo "export CLOUDSDK_CORE_PROJECT='$project'"
            echo "# Using GCP Vertex AI"
            ;;
        openai:oauth)
            output_enable_oauth openai
            echo "# Using Codex OAuth (Plus/Pro/Team)"
            ;;
        openai:api)
            output_disable_oauth openai
            local key
            if key=$(get_credential_local openai api 2>/dev/null); then
                echo "export OPENAI_API_KEY='$key'"
            else
                echo "# WARNING: No API key found. Add to Bitwarden as 'OpenAI API'"
            fi
            ;;
        openai:azure)
            output_disable_oauth openai
            echo "# Azure OpenAI - set AZURE_OPENAI_ENDPOINT and AZURE_OPENAI_API_KEY"
            ;;
        *)
            echo "# Unknown: $provider:$method"
            ;;
    esac

    echo "export AI_ACCESS_${provider^^}='$method'"
}

# Get credential from Bitwarden (local fallback)
get_credential_local() {
    local provider="$1"
    local type="$2"

    if command -v bw &>/dev/null && [[ "$(bw status 2>/dev/null | jq -r '.status')" == "unlocked" ]]; then
        local bw_names=()
        case "$provider" in
            anthropic) bw_names=("Anthropic API" "anthropic-api" "Claude API") ;;
            google)    bw_names=("Google AI API" "google-ai-api" "Gemini API") ;;
            openai)    bw_names=("OpenAI API" "openai-api" "ChatGPT API") ;;
        esac

        for name in "${bw_names[@]}"; do
            local secret
            secret=$(bw get password "$name" 2>/dev/null) && {
                echo "$secret"
                return 0
            }
        done
    fi

    return 1
}

# ============================================
# VALIDATION
# ============================================

check_access() {
    local provider="$1"
    local method="${2:-$(get_default_access "$provider")}"

    log_info "Checking $provider via $method..."

    # Try baton first
    if baton_available; then
        if baton_creds_ready "$provider"; then
            log_ok "$provider: credentials ready (via baton)"
            return 0
        fi
    fi

    # Fallback to local validation
    check_access_local "$provider" "$method"
}

check_access_local() {
    local provider="$1"
    local method="$2"

    # Set up environment
    eval "$(output_env_setup "$provider" "$method" 2>/dev/null)"

    case "$provider:$method" in
        anthropic:oauth)
            if command -v claude &>/dev/null && claude --version &>/dev/null; then
                log_ok "Claude OAuth: authenticated"
                return 0
            else
                log_error "Claude OAuth: not authenticated (run 'claude login')"
                return 1
            fi
            ;;
        anthropic:api)
            if [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
                local status
                status=$(curl -s -o /dev/null -w "%{http_code}" \
                    -H "x-api-key: $ANTHROPIC_API_KEY" \
                    -H "anthropic-version: 2023-06-01" \
                    "https://api.anthropic.com/v1/models")
                if [[ "$status" == "200" ]]; then
                    log_ok "Anthropic API: valid"
                    return 0
                else
                    log_error "Anthropic API: invalid (HTTP $status)"
                    return 1
                fi
            else
                log_error "Anthropic API: no key set"
                return 1
            fi
            ;;
        anthropic:bedrock)
            if aws sts get-caller-identity &>/dev/null; then
                if aws bedrock list-foundation-models --max-results 1 &>/dev/null; then
                    log_ok "AWS Bedrock: accessible"
                    return 0
                else
                    log_error "AWS Bedrock: no access (check IAM permissions)"
                    return 1
                fi
            else
                log_error "AWS: not authenticated (run 'aws sso login')"
                return 1
            fi
            ;;
        google:oauth)
            if command -v gemini &>/dev/null; then
                log_ok "Gemini CLI: installed"
                return 0
            else
                log_error "Gemini CLI: not installed"
                return 1
            fi
            ;;
        google:api)
            if [[ -n "${GEMINI_API_KEY:-}" ]]; then
                local status
                status=$(curl -s -o /dev/null -w "%{http_code}" \
                    "https://generativelanguage.googleapis.com/v1/models?key=$GEMINI_API_KEY")
                if [[ "$status" == "200" ]]; then
                    log_ok "Gemini API: valid"
                    return 0
                else
                    log_error "Gemini API: invalid (HTTP $status)"
                    return 1
                fi
            else
                log_error "Gemini API: no key set"
                return 1
            fi
            ;;
        google:vertex)
            if gcloud auth application-default print-access-token &>/dev/null; then
                log_ok "GCP Vertex: authenticated"
                return 0
            else
                log_error "GCP Vertex: not authenticated"
                return 1
            fi
            ;;
        openai:oauth)
            if command -v codex &>/dev/null; then
                log_ok "Codex CLI: installed"
                return 0
            else
                log_error "Codex CLI: not installed"
                return 1
            fi
            ;;
        openai:api)
            if [[ -n "${OPENAI_API_KEY:-}" ]]; then
                local status
                status=$(curl -s -o /dev/null -w "%{http_code}" \
                    -H "Authorization: Bearer $OPENAI_API_KEY" \
                    "https://api.openai.com/v1/models")
                if [[ "$status" == "200" ]]; then
                    log_ok "OpenAI API: valid"
                    return 0
                else
                    log_error "OpenAI API: invalid (HTTP $status)"
                    return 1
                fi
            else
                log_error "OpenAI API: no key set"
                return 1
            fi
            ;;
        openai:azure)
            if [[ -n "${AZURE_OPENAI_ENDPOINT:-}" ]] && [[ -n "${AZURE_OPENAI_API_KEY:-}" ]]; then
                log_ok "Azure OpenAI: configured"
                return 0
            else
                log_error "Azure OpenAI: missing config"
                return 1
            fi
            ;;
        *)
            log_warn "Unknown check: $provider:$method"
            return 1
            ;;
    esac
}

# ============================================
# STATUS DISPLAY
# ============================================

cmd_status() {
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}              AI Access Configuration                    ${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # Check baton status
    if baton_available; then
        echo -e "${GREEN}●${NC} Baton service: ${GREEN}connected${NC} ($BATON_URL)"

        # Get keepalive health from baton
        local keepalive_status
        keepalive_status=$(baton_keepalive_status)
        local healthy
        healthy=$(echo "$keepalive_status" | jq -r '.healthy // true')
        if [[ "$healthy" == "true" ]]; then
            echo -e "  Credentials: ${GREEN}healthy${NC}"
        else
            local unhealthy
            unhealthy=$(echo "$keepalive_status" | jq -r '.unhealthy[]? // empty' | tr '\n' ', ')
            echo -e "  Credentials: ${YELLOW}needs attention${NC} ($unhealthy)"
        fi
    else
        echo -e "${YELLOW}○${NC} Baton service: ${DIM}not available${NC} (using local auth)"
    fi
    echo ""

    for provider in anthropic google openai; do
        local default_method=$(get_default_access "$provider")
        local provider_upper="${provider^}"

        echo -e "${BOLD}$provider_upper${NC} (default: ${CYAN}$default_method${NC})"

        # Try to get status from baton
        if baton_available; then
            local baton_status
            baton_status=$(baton_auth_status "$provider")
            local recommended
            recommended=$(echo "$baton_status" | jq -r '.recommended // "none"')

            if [[ "$recommended" != "none" ]]; then
                echo -e "  ${DIM}recommended: $recommended${NC}"
            fi

            # Show method status from baton
            for method in $(get_methods_for_provider "$provider"); do
                local available
                available=$(echo "$baton_status" | jq -r ".methods.$method.available // false")
                local marker=""
                [[ "$method" == "$default_method" ]] && marker=" ${CYAN}◀ default${NC}"

                if [[ "$available" == "true" ]]; then
                    printf "  %-10s %s%b\n" "$method:" "✅" "$marker"
                else
                    printf "  %-10s %s%b\n" "$method:" "⚪" "$marker"
                fi
            done
        else
            # Fallback to local status check
            for method in $(get_methods_for_provider "$provider"); do
                check_method_status_local "$provider" "$method" "$default_method"
            done
        fi
        echo ""
    done

    echo -e "${DIM}Switch with: ai-access <provider> <method>${NC}"
    echo -e "${DIM}Example: ai-access anthropic bedrock${NC}"
}

get_methods_for_provider() {
    local provider="$1"
    case "$provider" in
        anthropic) echo "oauth api bedrock" ;;
        google)    echo "oauth api vertex" ;;
        openai)    echo "oauth api azure" ;;
    esac
}

check_method_status_local() {
    local provider="$1"
    local method="$2"
    local default="$3"

    local marker=""
    [[ "$method" == "$default" ]] && marker=" ${CYAN}◀ default${NC}"

    local status="⚪"
    case "$provider:$method" in
        anthropic:oauth)
            for f in ~/.claude/auth.json ~/.config/claude/auth.json; do
                [[ -f "$f" ]] && { status="✅"; break; }
            done
            [[ -f ~/.claude/auth.json.disabled ]] && status="⏸️ "
            ;;
        anthropic:api)
            command -v bw &>/dev/null && bw get password "Anthropic API" &>/dev/null 2>&1 && status="✅"
            ;;
        anthropic:bedrock)
            aws sts get-caller-identity &>/dev/null 2>&1 && status="✅"
            ;;
        google:oauth)
            command -v gemini &>/dev/null && status="✅"
            ;;
        google:api)
            command -v bw &>/dev/null && bw get password "Google AI API" &>/dev/null 2>&1 && status="✅"
            ;;
        google:vertex)
            gcloud auth application-default print-access-token &>/dev/null 2>&1 && status="✅"
            ;;
        openai:oauth)
            for f in ~/.codex/auth.json ~/.config/codex/auth.json; do
                [[ -f "$f" ]] && { status="✅"; break; }
            done
            ;;
        openai:api)
            command -v bw &>/dev/null && bw get password "OpenAI API" &>/dev/null 2>&1 && status="✅"
            ;;
        openai:azure)
            [[ -n "${AZURE_OPENAI_ENDPOINT:-}" ]] && status="✅"
            ;;
    esac

    printf "  %-10s %s%b\n" "$method:" "$status" "$marker"
}

# ============================================
# MAIN
# ============================================

main() {
    local cmd="${1:-}"

    case "$cmd" in
        status|"")
            cmd_status
            ;;
        env)
            local provider="${2:-}"
            local method="${3:-}"
            [[ -z "$provider" ]] && { log_error "Usage: ai-access env <provider> [method]"; exit 1; }
            output_env_setup "$provider" "$method"
            ;;
        check)
            local provider="${2:-}"
            local method="${3:-}"
            [[ -z "$provider" ]] && { log_error "Usage: ai-access check <provider> [method]"; exit 1; }
            check_access "$provider" "$method"
            ;;
        anthropic|google|openai)
            local provider="$cmd"
            local method="${2:-}"
            if [[ -z "$method" ]]; then
                echo "Current: $(get_default_access "$provider")"
                echo "Available methods for $provider:"
                case "$provider" in
                    anthropic) echo "  oauth, api, bedrock" ;;
                    google)    echo "  oauth, api, vertex" ;;
                    openai)    echo "  oauth, api, azure" ;;
                esac

                # Show recommended from baton if available
                if baton_available; then
                    local recommended
                    recommended=$(baton_auth_status "$provider" | jq -r '.recommended // "none"')
                    [[ "$recommended" != "none" ]] && echo -e "\n${GREEN}Recommended:${NC} $recommended"
                fi
            else
                set_default_access "$provider" "$method"
                log_ok "Set $provider default to: $method"
                echo ""
                echo "To apply now:"
                echo "  eval \"\$(ai-access env $provider)\""
            fi
            ;;
        -h|--help|help)
            usage
            ;;
        *)
            log_error "Unknown command: $cmd"
            usage
            exit 1
            ;;
    esac
}

main "$@"
