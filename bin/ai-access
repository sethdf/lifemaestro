#!/usr/bin/env bash
# ai-access - Manage AI provider authentication and access methods
# Ensures clean environment switching between OAuth, API, and Cloud access

set -euo pipefail

MAESTRO_ROOT="${MAESTRO_ROOT:-${XDG_CONFIG_HOME:-$HOME/.config}/lifemaestro}"
MAESTRO_STATE="${MAESTRO_STATE:-${XDG_STATE_HOME:-$HOME/.local/state}/lifemaestro}"
AI_ACCESS_FILE="$MAESTRO_STATE/ai-access.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

log_info()  { echo -e "${BLUE}▶${NC} $*"; }
log_ok()    { echo -e "${GREEN}✓${NC} $*"; }
log_warn()  { echo -e "${YELLOW}!${NC} $*"; }
log_error() { echo -e "${RED}✗${NC} $*" >&2; }

# ============================================
# ACCESS METHOD DEFINITIONS
# ============================================

# Anthropic access methods
declare -A ANTHROPIC_ACCESS=(
    [oauth]="Claude Code OAuth (Pro/Team subscription)"
    [api]="API Key (console.anthropic.com)"
    [bedrock]="AWS Bedrock"
)

# Google access methods
declare -A GOOGLE_ACCESS=(
    [oauth]="Google OAuth (Free/Advanced subscription)"
    [api]="API Key (aistudio.google.com)"
    [vertex]="GCP Vertex AI"
)

# OpenAI access methods
declare -A OPENAI_ACCESS=(
    [oauth]="ChatGPT OAuth (Plus/Team subscription)"
    [api]="API Key (platform.openai.com)"
    [azure]="Azure OpenAI"
)

usage() {
    cat <<EOF
ai-access - Manage AI provider access methods

Usage: ai-access <command> [args...]

Commands:
    status                      Show current access configuration
    <provider> <method>         Set default access method
    env <provider> [method]     Output env vars for access method (for eval)
    check <provider> [method]   Validate specific access method works

Providers & Methods:
    anthropic   oauth | api | bedrock
    google      oauth | api | vertex
    openai      oauth | api | azure

Examples:
    ai-access status                    # Show all access methods
    ai-access anthropic bedrock         # Switch Claude to Bedrock
    ai-access google vertex             # Switch Gemini to Vertex AI
    eval "\$(ai-access env anthropic)"   # Set env for current method

How it works:
    When switching methods, conflicting auth is DISABLED to prevent confusion:
    - Switching to 'bedrock' → unsets ANTHROPIC_API_KEY, disables OAuth token
    - Switching to 'api' → unsets AWS vars, disables OAuth token
    - Switching to 'oauth' → unsets API key and AWS vars
EOF
}

# ============================================
# STATE MANAGEMENT
# ============================================

ensure_state_file() {
    mkdir -p "$(dirname "$AI_ACCESS_FILE")"
    if [[ ! -f "$AI_ACCESS_FILE" ]]; then
        cat > "$AI_ACCESS_FILE" <<EOF
{
  "anthropic": { "default": "oauth" },
  "google": { "default": "oauth" },
  "openai": { "default": "api" }
}
EOF
    fi
}

get_default_access() {
    local provider="$1"
    ensure_state_file
    jq -r ".[\"$provider\"].default // \"oauth\"" "$AI_ACCESS_FILE"
}

set_default_access() {
    local provider="$1"
    local method="$2"
    ensure_state_file
    
    local tmp_file
    tmp_file=$(mktemp)
    jq --arg p "$provider" --arg m "$method" \
        '.[$p].default = $m' "$AI_ACCESS_FILE" > "$tmp_file"
    mv "$tmp_file" "$AI_ACCESS_FILE"
}

# ============================================
# ENVIRONMENT SETUP (Clean Isolation)
# ============================================

# Clear ALL auth for a provider (clean slate)
clear_provider_auth() {
    local provider="$1"
    
    case "$provider" in
        anthropic)
            unset ANTHROPIC_API_KEY 2>/dev/null || true
            unset AWS_PROFILE AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN 2>/dev/null || true
            unset ANTHROPIC_MODEL 2>/dev/null || true
            ;;
        google)
            unset GEMINI_API_KEY GOOGLE_API_KEY 2>/dev/null || true
            unset GOOGLE_APPLICATION_CREDENTIALS 2>/dev/null || true
            unset CLOUDSDK_CORE_PROJECT 2>/dev/null || true
            ;;
        openai)
            unset OPENAI_API_KEY 2>/dev/null || true
            unset AZURE_OPENAI_API_KEY AZURE_OPENAI_ENDPOINT 2>/dev/null || true
            ;;
    esac
}

# Output commands to disable OAuth token (for eval)
output_disable_oauth() {
    local provider="$1"

    case "$provider" in
        anthropic)
            # Claude Code auth locations - output commands to move files
            for f in ~/.claude/auth.json ~/.config/claude/auth.json ~/.claude.json; do
                cat <<EOF
if [[ -f "$f" ]] && [[ ! -f "$f.disabled" ]]; then
    mv "$f" "$f.disabled"
    echo "# Disabled OAuth: $f"
fi
EOF
            done
            ;;
        google)
            # Gemini CLI typically uses gcloud ADC, not a separate token file
            echo "# Google OAuth managed via gcloud"
            ;;
    esac
}

# Output commands to re-enable OAuth token (for eval)
output_enable_oauth() {
    local provider="$1"

    case "$provider" in
        anthropic)
            for f in ~/.claude/auth.json ~/.config/claude/auth.json ~/.claude.json; do
                cat <<EOF
if [[ -f "$f.disabled" ]]; then
    mv "$f.disabled" "$f"
    echo "# Enabled OAuth: $f"
fi
EOF
            done
            ;;
    esac
}

# Get credential from Bitwarden or env
get_credential() {
    local provider="$1"
    local type="$2"
    
    # Try Bitwarden first
    if command -v bw &>/dev/null && [[ "$(bw status 2>/dev/null | jq -r '.status')" == "unlocked" ]]; then
        local bw_name="${provider}-${type}-key"
        local secret
        secret=$(bw get password "$bw_name" 2>/dev/null) && {
            echo "$secret"
            return 0
        }
    fi
    
    # Fallback to environment variable naming convention
    local env_var
    case "$provider:$type" in
        anthropic:api) env_var="ANTHROPIC_API_KEY_STORED" ;;
        google:api)    env_var="GEMINI_API_KEY_STORED" ;;
        openai:api)    env_var="OPENAI_API_KEY_STORED" ;;
        *)             env_var="" ;;
    esac
    
    [[ -n "$env_var" ]] && [[ -n "${!env_var:-}" ]] && {
        echo "${!env_var}"
        return 0
    }
    
    return 1
}

# Output env setup for a specific access method (for eval)
output_env_setup() {
    local provider="$1"
    local method="${2:-$(get_default_access "$provider")}"
    
    echo "# ai-access env setup: $provider via $method"
    
    # First, clear conflicting auth
    case "$provider" in
        anthropic)
            echo "unset ANTHROPIC_API_KEY 2>/dev/null || true"
            echo "unset AWS_PROFILE AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN 2>/dev/null || true"
            ;;
        google)
            echo "unset GEMINI_API_KEY GOOGLE_API_KEY 2>/dev/null || true"
            ;;
        openai)
            echo "unset OPENAI_API_KEY AZURE_OPENAI_API_KEY AZURE_OPENAI_ENDPOINT 2>/dev/null || true"
            ;;
    esac
    
    # Then set up the desired method
    case "$provider:$method" in
        anthropic:oauth)
            output_enable_oauth anthropic
            echo "# Using Claude Code OAuth"
            ;;
        anthropic:api)
            output_disable_oauth anthropic
            local key
            if key=$(get_credential anthropic api 2>/dev/null); then
                echo "export ANTHROPIC_API_KEY='$key'"
            else
                echo "# WARNING: No API key found. Set ANTHROPIC_API_KEY_STORED or add to Bitwarden as 'anthropic-api-key'"
            fi
            ;;
        anthropic:bedrock)
            output_disable_oauth anthropic
            # Get AWS profile from config or default
            local profile="${AWS_PROFILE_ANTHROPIC:-default}"
            local region="${AWS_REGION_ANTHROPIC:-us-east-1}"
            echo "export AWS_PROFILE='$profile'"
            echo "export AWS_REGION='$region'"
            echo "# Using AWS Bedrock with profile: $profile"
            ;;
        google:oauth)
            echo "# Using Google OAuth (gemini login)"
            ;;
        google:api)
            local key
            if key=$(get_credential google api 2>/dev/null); then
                echo "export GEMINI_API_KEY='$key'"
            else
                echo "# WARNING: No API key found. Set GEMINI_API_KEY_STORED or add to Bitwarden as 'google-api-key'"
            fi
            ;;
        google:vertex)
            local project="${GCP_PROJECT:-}"
            local region="${GCP_REGION:-us-central1}"
            [[ -n "$project" ]] && echo "export CLOUDSDK_CORE_PROJECT='$project'"
            echo "# Using GCP Vertex AI"
            ;;
        openai:api)
            local key
            if key=$(get_credential openai api 2>/dev/null); then
                echo "export OPENAI_API_KEY='$key'"
            else
                echo "# WARNING: No API key found. Set OPENAI_API_KEY_STORED or add to Bitwarden as 'openai-api-key'"
            fi
            ;;
        openai:azure)
            echo "# Azure OpenAI - set AZURE_OPENAI_ENDPOINT and AZURE_OPENAI_API_KEY"
            ;;
        *)
            echo "# Unknown: $provider:$method"
            ;;
    esac
    
    echo "export AI_ACCESS_${provider^^}='$method'"
}

# ============================================
# VALIDATION
# ============================================

check_access() {
    local provider="$1"
    local method="${2:-$(get_default_access "$provider")}"
    
    log_info "Checking $provider via $method..."
    
    # Set up environment
    eval "$(output_env_setup "$provider" "$method" 2>/dev/null)"
    
    case "$provider:$method" in
        anthropic:oauth)
            if command -v claude &>/dev/null && claude --version &>/dev/null; then
                log_ok "Claude OAuth: authenticated"
                return 0
            else
                log_error "Claude OAuth: not authenticated (run 'claude login')"
                return 1
            fi
            ;;
        anthropic:api)
            if [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
                local status
                status=$(curl -s -o /dev/null -w "%{http_code}" \
                    -H "x-api-key: $ANTHROPIC_API_KEY" \
                    -H "anthropic-version: 2023-06-01" \
                    "https://api.anthropic.com/v1/models")
                if [[ "$status" == "200" ]]; then
                    log_ok "Anthropic API: valid"
                    return 0
                else
                    log_error "Anthropic API: invalid (HTTP $status)"
                    return 1
                fi
            else
                log_error "Anthropic API: no key set"
                return 1
            fi
            ;;
        anthropic:bedrock)
            if aws sts get-caller-identity &>/dev/null; then
                if aws bedrock list-foundation-models --max-results 1 &>/dev/null; then
                    log_ok "AWS Bedrock: accessible"
                    return 0
                else
                    log_error "AWS Bedrock: no access (check IAM permissions)"
                    return 1
                fi
            else
                log_error "AWS: not authenticated (run 'aws sso login')"
                return 1
            fi
            ;;
        google:oauth)
            if command -v gemini &>/dev/null; then
                log_ok "Gemini CLI: installed (run 'gemini' to login if needed)"
                return 0
            else
                log_error "Gemini CLI: not installed"
                return 1
            fi
            ;;
        google:api)
            if [[ -n "${GEMINI_API_KEY:-}" ]]; then
                local status
                status=$(curl -s -o /dev/null -w "%{http_code}" \
                    "https://generativelanguage.googleapis.com/v1/models?key=$GEMINI_API_KEY")
                if [[ "$status" == "200" ]]; then
                    log_ok "Gemini API: valid"
                    return 0
                else
                    log_error "Gemini API: invalid (HTTP $status)"
                    return 1
                fi
            else
                log_error "Gemini API: no key set"
                return 1
            fi
            ;;
        google:vertex)
            if gcloud auth application-default print-access-token &>/dev/null; then
                log_ok "GCP Vertex: authenticated"
                return 0
            else
                log_error "GCP Vertex: not authenticated (run 'gcloud auth application-default login')"
                return 1
            fi
            ;;
        openai:api)
            if [[ -n "${OPENAI_API_KEY:-}" ]]; then
                local status
                status=$(curl -s -o /dev/null -w "%{http_code}" \
                    -H "Authorization: Bearer $OPENAI_API_KEY" \
                    "https://api.openai.com/v1/models")
                if [[ "$status" == "200" ]]; then
                    log_ok "OpenAI API: valid"
                    return 0
                else
                    log_error "OpenAI API: invalid (HTTP $status)"
                    return 1
                fi
            else
                log_error "OpenAI API: no key set"
                return 1
            fi
            ;;
        *)
            log_warn "Unknown check: $provider:$method"
            return 1
            ;;
    esac
}

# ============================================
# STATUS DISPLAY
# ============================================

cmd_status() {
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}              AI Access Configuration                    ${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    
    for provider in anthropic google openai; do
        local default_method=$(get_default_access "$provider")
        local provider_upper="${provider^}"
        
        echo -e "${BOLD}$provider_upper${NC} (default: ${CYAN}$default_method${NC})"
        
        case "$provider" in
            anthropic)
                for method in oauth api bedrock; do
                    check_method_status "$provider" "$method" "$default_method"
                done
                ;;
            google)
                for method in oauth api vertex; do
                    check_method_status "$provider" "$method" "$default_method"
                done
                ;;
            openai)
                for method in api azure; do
                    check_method_status "$provider" "$method" "$default_method"
                done
                ;;
        esac
        echo ""
    done
    
    echo -e "${DIM}Switch with: ai-access <provider> <method>${NC}"
    echo -e "${DIM}Example: ai-access anthropic bedrock${NC}"
}

check_method_status() {
    local provider="$1"
    local method="$2"
    local default="$3"
    
    local marker=""
    [[ "$method" == "$default" ]] && marker=" ${CYAN}◀ default${NC}"
    
    # Quick status check without full validation
    local status="⚪"
    case "$provider:$method" in
        anthropic:oauth)
            for f in ~/.claude/auth.json ~/.config/claude/auth.json; do
                [[ -f "$f" ]] && { status="✅"; break; }
            done
            [[ -f ~/.claude/auth.json.disabled ]] && status="⏸️ "
            ;;
        anthropic:api)
            [[ -n "${ANTHROPIC_API_KEY_STORED:-}" ]] && status="✅"
            command -v bw &>/dev/null && bw get password anthropic-api-key &>/dev/null && status="✅"
            ;;
        anthropic:bedrock)
            aws sts get-caller-identity &>/dev/null && status="✅"
            ;;
        google:oauth)
            command -v gemini &>/dev/null && status="✅"
            ;;
        google:api)
            [[ -n "${GEMINI_API_KEY_STORED:-}" ]] && status="✅"
            ;;
        google:vertex)
            gcloud auth application-default print-access-token &>/dev/null 2>&1 && status="✅"
            ;;
        openai:api)
            [[ -n "${OPENAI_API_KEY_STORED:-}" ]] && status="✅"
            ;;
        openai:azure)
            [[ -n "${AZURE_OPENAI_ENDPOINT:-}" ]] && status="✅"
            ;;
    esac
    
    printf "  %-10s %s%b\n" "$method:" "$status" "$marker"
}

# ============================================
# MAIN
# ============================================

main() {
    local cmd="${1:-}"
    
    case "$cmd" in
        status|"")
            cmd_status
            ;;
        env)
            local provider="${2:-}"
            local method="${3:-}"
            [[ -z "$provider" ]] && { log_error "Usage: ai-access env <provider> [method]"; exit 1; }
            output_env_setup "$provider" "$method"
            ;;
        check)
            local provider="${2:-}"
            local method="${3:-}"
            [[ -z "$provider" ]] && { log_error "Usage: ai-access check <provider> [method]"; exit 1; }
            check_access "$provider" "$method"
            ;;
        anthropic|google|openai)
            local provider="$cmd"
            local method="${2:-}"
            if [[ -z "$method" ]]; then
                echo "Current: $(get_default_access "$provider")"
                echo "Available methods for $provider:"
                case "$provider" in
                    anthropic) echo "  oauth, api, bedrock" ;;
                    google)    echo "  oauth, api, vertex" ;;
                    openai)    echo "  api, azure" ;;
                esac
            else
                set_default_access "$provider" "$method"
                log_ok "Set $provider default to: $method"
                echo ""
                echo "To apply now:"
                echo "  eval \"\$(ai-access env $provider)\""
            fi
            ;;
        -h|--help|help)
            usage
            ;;
        *)
            log_error "Unknown command: $cmd"
            usage
            exit 1
            ;;
    esac
}

main "$@"
