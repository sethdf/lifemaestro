#!/usr/bin/env bash
# zone - Manage LifeMaestro zones via baton
# 12-Factor CLI compliant

set -euo pipefail

MAESTRO_ROOT="${MAESTRO_ROOT:-${XDG_CONFIG_HOME:-$HOME/.config}/lifemaestro}"
BATON_URL="${BATON_URL:-http://localhost:4000}"
SCRIPTS_DIR="$MAESTRO_ROOT/.claude/skills/zone-context/scripts"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

log_info()  { echo -e "${BLUE}▶${NC} $*"; }
log_ok()    { echo -e "${GREEN}✓${NC} $*"; }
log_warn()  { echo -e "${YELLOW}!${NC} $*" >&2; }
log_error() { echo -e "${RED}✗${NC} $*" >&2; }

# ============================================
# BATON INTEGRATION
# ============================================

baton_available() {
    curl -s --connect-timeout 1 "$BATON_URL/healthz" &>/dev/null
}

baton_zones_list() {
    curl -s "$BATON_URL/zones" 2>/dev/null
}

baton_zones_current() {
    curl -s "$BATON_URL/zones/current" 2>/dev/null
}

baton_zones_get() {
    local zone="$1"
    curl -s "$BATON_URL/zones/$zone" 2>/dev/null
}

baton_zones_switch() {
    local zone="$1"
    curl -s -X POST "$BATON_URL/zones/switch" \
        -H "Content-Type: application/json" \
        -d "{\"zone\":\"$zone\"}" 2>/dev/null
}

# ============================================
# VALIDATION
# ============================================

validate_zone_name() {
    local name="$1"
    if [[ ! "$name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        log_error "Invalid zone name '$name'. Use only letters, numbers, dash, underscore."
        return 1
    fi
    return 0
}

# ============================================
# COMMANDS
# ============================================

cmd_current() {
    if baton_available; then
        local result
        result=$(baton_zones_current)
        local zone
        zone=$(echo "$result" | jq -r '.zone // "none"')
        local session
        session=$(echo "$result" | jq -r '.session // ""')

        if [[ "$zone" == "none" ]] || [[ "$zone" == "null" ]] || [[ -z "$zone" ]]; then
            echo -e "${DIM}No zone set${NC}"
            echo ""
            echo "Set with: eval \"\$(zone switch <zone-name>)\""
        else
            echo -e "${CYAN}Current zone:${NC} ${BOLD}$zone${NC}"
            [[ -n "$session" ]] && echo -e "${DIM}Session: $session${NC}"

            # Show zone config
            local config
            config=$(echo "$result" | jq -r '.config // {}')
            if [[ "$config" != "{}" ]]; then
                local model
                model=$(echo "$config" | jq -r '.default_model // ""')
                local auth
                auth=$(echo "$config" | jq -r '.preferred_auth // ""')
                [[ -n "$model" ]] && echo -e "${DIM}Model: $model${NC}"
                [[ -n "$auth" ]] && echo -e "${DIM}Auth: $auth${NC}"
            fi
        fi
    else
        # Fallback to local detection
        if [[ -x "$SCRIPTS_DIR/zone-detect.sh" ]]; then
            "$SCRIPTS_DIR/zone-detect.sh"
        elif [[ -n "${MAESTRO_ZONE:-}" ]]; then
            echo -e "${CYAN}Current zone:${NC} ${BOLD}$MAESTRO_ZONE${NC}"
        else
            echo -e "${DIM}No zone set (MAESTRO_ZONE not defined)${NC}"
        fi
    fi
}

cmd_list() {
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}              Available Zones                            ${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    if baton_available; then
        local result
        result=$(baton_zones_list)
        local current
        current=$(echo "$result" | jq -r '.current // ""')

        echo "$result" | jq -r '.zones[]? | "\(.name)|\(.default_model // "")|\(.preferred_auth // "")"' | while IFS='|' read -r name model auth; do
            local marker=""
            [[ "$name" == "$current" ]] && marker=" ${CYAN}◀ current${NC}"

            printf "  ${BOLD}%-15s${NC}" "$name"
            [[ -n "$model" ]] && printf " ${DIM}model: %s${NC}" "$model"
            [[ -n "$auth" ]] && printf " ${DIM}auth: %s${NC}" "$auth"
            echo -e "$marker"
        done

        if [[ $(echo "$result" | jq '.zones | length') -eq 0 ]]; then
            echo -e "${DIM}No zones configured${NC}"
            echo ""
            echo "Configure zones in baton.toml:"
            echo "  [zones.work]"
            echo "  default_model = \"claude-sonnet-4-20250514\""
        fi
    else
        # Try local scripts
        if [[ -x "$SCRIPTS_DIR/zone-list.sh" ]]; then
            "$SCRIPTS_DIR/zone-list.sh"
        else
            echo -e "${DIM}Baton not available, no zone configuration${NC}"
        fi
    fi

    echo ""
}

cmd_switch() {
    local zone_name="$1"
    validate_zone_name "$zone_name" || exit 1

    if baton_available; then
        local result
        result=$(baton_zones_switch "$zone_name")

        # Check for error
        local error
        error=$(echo "$result" | jq -r '.detail // ""')
        if [[ -n "$error" ]] && [[ "$error" != "null" ]]; then
            log_error "$error"
            exit 1
        fi

        # Output export commands
        echo "$result" | jq -r '.export_cmd // ""'

        # Show config info as comment
        local model
        model=$(echo "$result" | jq -r '.config.default_model // ""')
        local auth
        auth=$(echo "$result" | jq -r '.config.preferred_auth // ""')

        echo ""
        echo "# Zone: $zone_name"
        [[ -n "$model" ]] && echo "# Model: $model"
        [[ -n "$auth" ]] && echo "# Auth: $auth"
    else
        # Fallback to local scripts
        if [[ -x "$SCRIPTS_DIR/zone-switch.sh" ]]; then
            "$SCRIPTS_DIR/zone-switch.sh" "$zone_name"
        else
            # Minimal fallback - just set MAESTRO_ZONE
            echo "export MAESTRO_ZONE=\"$zone_name\""
            echo ""
            echo "# Zone: $zone_name"
        fi
    fi

    echo ""
    echo "# To apply: eval \"\$(zone switch $zone_name)\""
}

cmd_info() {
    local zone_name="$1"
    validate_zone_name "$zone_name" || exit 1

    if baton_available; then
        local result
        result=$(baton_zones_get "$zone_name")

        # Check for error
        local error
        error=$(echo "$result" | jq -r '.detail // ""')
        if [[ -n "$error" ]] && [[ "$error" != "null" ]]; then
            log_error "$error"
            exit 1
        fi

        echo -e "${BOLD}Zone: $zone_name${NC}"
        echo ""
        echo "$result" | jq -r '
            "Model:      \(.default_model // "default")",
            "Alias:      \(.default_alias // "smart")",
            "Blocked:    \(.blocked_providers // [] | join(", ") | if . == "" then "none" else . end)",
            "Cost limit: \(.cost_limit // "none")",
            "Rate limit: \(.rate_limit_rpm // "none") rpm"
        '
    else
        log_warn "Baton not available"
        exit 1
    fi
}

usage() {
    cat <<EOF
zone - Manage LifeMaestro zones via Baton

Usage: zone [command] [args]

Commands:
    current             Show current zone (default)
    list                List all configured zones
    switch <name>       Output commands to switch zone (eval to apply)
    info <name>         Show zone configuration details

Options:
    -v, --version       Show version
    -h, --help          Show this help

Examples:
    zone                        # Show current zone
    zone list                   # List all zones
    zone switch personal        # Show switch commands
    zone info work              # Show work zone config
    eval "\$(zone switch work)"  # Actually switch

Environment:
    MAESTRO_ZONE        Current zone (set by switch)
    BATON_URL           Baton server URL (default: http://localhost:4000)

Zones are configured in baton.toml:
    [zones.work]
    default_model = "claude-sonnet-4-20250514"
    default_temperature = 0.3

    [zones.personal]
    default_model = "claude-3-5-haiku-latest"
    preferred_auth = "oauth"
EOF
}

# ============================================
# MAIN
# ============================================

cmd="${1:-current}"
shift || true

case "$cmd" in
    current|c)
        cmd_current
        ;;
    list|ls|l)
        cmd_list
        ;;
    switch|s)
        if [[ $# -lt 1 ]]; then
            log_error "Usage: zone switch <zone-name>"
            exit 1
        fi
        cmd_switch "$1"
        ;;
    info|i)
        if [[ $# -lt 1 ]]; then
            log_error "Usage: zone info <zone-name>"
            exit 1
        fi
        cmd_info "$1"
        ;;
    version|-v|--version)
        echo "zone (lifemaestro) ${MAESTRO_VERSION:-0.3.0}"
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        # If argument looks like a zone name, treat as switch
        if validate_zone_name "$cmd" 2>/dev/null; then
            cmd_switch "$cmd"
        else
            log_error "Unknown command: $cmd"
            echo ""
            usage
            exit 1
        fi
        ;;
esac
